<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EFSRT — Centros Laborales</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="icon" type="image/png" href="icono.png">
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#7c3aed',
              'primary-dark': '#5b21b6',
              'primary-light': '#a78bfa',
              'background-light': '#f8fafc',
              'background-dark': '#0f172a',
              'text-main': '#1e293b',
              'text-muted': '#64748b',
            },
            fontFamily: {
              display: ['Lexend', 'sans-serif'],
            },
            borderRadius: {
              DEFAULT: '1.5rem',
              lg: '1.5rem',
              xl: '1.5rem',
              full: '9999px',
            },
          },
        },
      }
    </script>
    <style>
      body {
        font-family: 'Lexend', sans-serif;
      }
      /* Mobile/Custom Styles */
      .animate-fade-in {
        animation: fadeIn 0.4s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .required-star {
        color: #dc2626;
      }
      .step-bullet {
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .note {
        background: #fff7ed;
        border-left: 4px solid #f59e0b;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-background-light text-[#0d121b] antialiased">
    <main class="max-w-4xl mx-auto p-6 md:p-12">
      <header class="mb-8 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-extrabold text-primary">
            EFSRT — Centros Laborales
          </h1>
          <p class="text-sm text-text-muted mt-1">
            Formulario de registro — Experiencia Formativa en Situaciones Reales
            de Trabajo
          </p>
        </div>
        <img
          src="LOGO-NEUMANN.png"
          alt="Instituto Neumann"
          class="h-12 object-contain"
        />
      </header>

      <!-- Stepper -->
      <div class="mb-8">
        <!-- Desktop/Tablet Stepper -->
        <div
          class="hidden md:flex items-center justify-between relative px-4 py-4"
        >
          <!-- Connecting Line Background -->
          <div
            class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-100 -z-10 rounded-full"
          ></div>

          <!-- Active Line Progress -->
          <div
            id="stepper-progress"
            class="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-primary -z-10 rounded-full transition-all duration-500 ease-in-out"
            style="width: 0%"
          ></div>

          <!-- Step 1 -->
          <button
            type="button"
            onclick="goToStep(0)"
            class="step-btn group flex flex-col items-center gap-2 bg-transparent border-0 cursor-pointer focus:outline-none relative z-10"
            disabled
          >
            <div
              id="bullet-1"
              class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 bg-white border-primary text-primary shadow-[0_0_0_4px_rgba(255,255,255,1)]"
            >
              1
            </div>
            <div class="absolute top-12 w-32 text-center">
              <span class="block text-xs font-bold text-gray-900"
                >Estudiante</span
              >
              <span class="block text-[10px] text-gray-500 font-medium"
                >Datos personales</span
              >
            </div>
          </button>

          <!-- Step 2 -->
          <button
            type="button"
            onclick="goToStep(1)"
            class="step-btn group flex flex-col items-center gap-2 bg-transparent border-0 cursor-pointer focus:outline-none relative z-10"
            disabled
          >
            <div
              id="bullet-2"
              class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 bg-white border-gray-200 text-gray-400 shadow-[0_0_0_4px_rgba(255,255,255,1)]"
            >
              2
            </div>
            <div class="absolute top-12 w-32 text-center">
              <span class="block text-xs font-bold text-gray-900 opacity-60"
                >Organización (I)</span
              >
              <span
                class="block text-[10px] text-gray-500 font-medium opacity-60"
                >Identificación</span
              >
            </div>
          </button>

          <!-- Step 3 -->
          <button
            type="button"
            onclick="goToStep(2)"
            class="step-btn group flex flex-col items-center gap-2 bg-transparent border-0 cursor-pointer focus:outline-none relative z-10"
            disabled
          >
            <div
              id="bullet-3"
              class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 bg-white border-gray-200 text-gray-400 shadow-[0_0_0_4px_rgba(255,255,255,1)]"
            >
              3
            </div>
            <div class="absolute top-12 w-32 text-center">
              <span class="block text-xs font-bold text-gray-900 opacity-60"
                >Descripción</span
              >
              <span
                class="block text-[10px] text-gray-500 font-medium opacity-60"
                >Actividades</span
              >
            </div>
          </button>
        </div>

        <!-- Mobile Stepper -->
        <div
          class="md:hidden flex items-center justify-between bg-white p-4 rounded-xl border border-gray-100 shadow-sm"
        >
          <div class="flex items-center gap-3">
            <div class="relative">
              <svg
                class="w-10 h-10 -rotate-90 text-gray-100"
                viewBox="0 0 36 36"
              >
                <path
                  class="text-gray-100"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                />
                <path
                  id="mobile-progress-circle"
                  class="text-primary transition-all duration-500"
                  stroke-dasharray="0, 100"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                />
              </svg>
              <div
                class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-xs font-bold text-primary"
              >
                <span id="mobile-step-current">1</span>/<span
                  id="mobile-step-total"
                  >4</span
                >
              </div>
            </div>
            <div>
              <div
                id="mobile-step-title"
                class="text-sm font-bold text-gray-900"
              >
                Estudiante
              </div>
              <div id="mobile-step-subtitle" class="text-xs text-gray-500">
                Datos personales
              </div>
            </div>
          </div>
          <button
            class="text-xs font-medium text-primary hover:text-primary-dark"
          >
            Ver todo
          </button>
        </div>
      </div>

      <form
        id="efsrt-form"
        class="bg-white p-6 rounded-2xl border border-[#e6eef8] shadow-sm"
        novalidate
      >
        <!-- SECTION 1 - Estudiante -->
        <fieldset data-step="1" class="space-y-4">
          <legend class="text-lg font-bold text-[#0d121b]">
            EFSRT — Centros Laborales
          </legend>
          <p class="text-sm text-text-muted">
            La Experiencia Formativa en Situaciones Reales de Trabajo (EFSRT) se
            puede realizar en empresas, organizaciones o instituciones
            formalmente constituidas cuya actividad esté vinculada a tu
            formación.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold"
                >Nombres <span class="required-star">*</span></label
              >
              <input
                name="nombres"
                type="text"
                required
                placeholder="Ej: Juan Román"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 bg-background-light/50 text-sm outline-none"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Apellidos <span class="required-star">*</span></label
              >
              <input
                name="apellidos"
                type="text"
                required
                placeholder="Ej: Riquelme"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 bg-background-light/50 text-sm outline-none"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >DNI <span class="required-star">*</span></label
              >
              <input
                name="dni"
                type="text"
                required
                placeholder="70000000"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 bg-background-light/50 text-sm outline-none"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Correo Estudiantil <span class="required-star">*</span></label
              >
              <input
                name="correo_estudiantil"
                type="email"
                required
                placeholder="usuario@neumann.global"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 bg-background-light/50 text-sm outline-none"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Programa de Estudios
                <span class="required-star">*</span></label
              >
              <select
                name="programa"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-white text-sm focus:border-primary focus:ring-2 focus:ring-primary/20"
              >
                <option value="">Seleccione...</option>
                <option>Administración de Negocios Internacionales</option>
                <option>Contabilidad</option>
              </select>
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Ciclo de Estudios <span class="required-star">*</span></label
              >
              <select
                name="ciclo"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-white text-sm focus:border-primary focus:ring-2 focus:ring-primary/20"
              >
                <option value="">Seleccione ciclo...</option>
                <option>Primer Ciclo</option>
                <option>Segundo Ciclo</option>
                <option>Tercer Ciclo</option>
                <option>Cuarto Ciclo</option>
                <option>Quinto Ciclo</option>
                <option>Sexto Ciclo</option>
              </select>
            </div>
          </div>
        </fieldset>

        <!-- SECTION 2 - Organización I -->
        <fieldset data-step="2" class="hidden space-y-4">
          <legend class="text-lg font-bold">
            Sección 2 — Identificación de la Organización EFSRT
          </legend>
          <p class="text-sm text-text-muted">
            El objetivo de esta sección es identificar la organización donde el
            estudiante realiza la EFSRT.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold"
                >Razón Social <span class="required-star">*</span></label
              >
              <input
                name="razon_social"
                type="text"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >RUC <span class="required-star">*</span></label
              >
              <input
                name="ruc"
                type="text"
                pattern="\d*"
                required
                placeholder="20123456789"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Nombre y Apellido del Jefe Inmediato
                <span class="required-star">*</span></label
              >
              <input
                name="jefe"
                type="text"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Fecha de Inicio <span class="required-star">*</span></label
              >
              <input
                name="fecha_inicio"
                type="date"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-white text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div>
              <label class="text-sm font-semibold"
                >Total de horas realizadas (64 horas mínimas)
                <span class="required-star">*</span></label
              >
              <input
                name="horas"
                type="number"
                min="64"
                required
                placeholder="Ingresa solo el número"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold"
                >Descripción (opcional)</label
              >
              <textarea
                name="desc"
                rows="5"
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              ></textarea>
            </div>
          </div>

          <div class="mt-2 note text-sm">
            <div class="font-medium">⚠️ Nota:</div>
            <div>
              Recuerda que la constancia que adjuntes debe tener: nombre y
              apellidos del estudiante, rango de fechas, nombre de la empresa,
              RUC, cargo que ocupa, papel membretado, sello y firma.
            </div>
          </div>
        </fieldset>

        <!-- SECTION 3 - Descripción de la EFSRT -->
        <fieldset data-step="3" class="hidden space-y-4">
          <legend class="text-lg font-bold">
            Sección 3 — Descripción de la EFSRT
          </legend>
          <p class="text-sm text-text-muted">
            Describe las actividades y tareas que realiza el estudiante en la
            organización.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold"
                >Cargo que ocupa el estudiante
                <span class="required-star">*</span></label
              >
              <input
                name="cargo"
                type="text"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              />
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold"
                >Describa las actividades que realiza el estudiante
                <span class="required-star">*</span></label
              >
              <textarea
                id="actividades-input"
                name="actividades"
                rows="5"
                required
                class="mt-2 w-full pl-4 pr-3 py-3 rounded-lg border border-gray-200 bg-background-light/50 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
              ></textarea>
              <div
                id="word-count"
                class="text-xs text-right text-gray-500 mt-1"
              >
                0/300 palabras
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-semibold mb-2 block"
                >Adjuntar constancia de trabajo (PDF)
                <span class="required-star">*</span></label
              >

              <div
                id="drop-zone"
                class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer relative"
              >
                <input
                  id="constancia-input"
                  name="constancia"
                  type="file"
                  accept="application/pdf"
                  required
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <div class="pointer-events-none">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-10 w-10 text-gray-400 mx-auto mb-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  <p class="text-sm text-gray-600 font-medium">
                    <span class="text-primary hover:underline"
                      >Haz clic para subir</span
                    >
                    o arrastra y suelta
                  </p>
                  <p id="file-name-display" class="text-xs text-gray-500 mt-1">
                    Solo PDF hasta 10MB
                  </p>
                </div>
              </div>

              <p class="text-xs text-gray-500 mt-1">
                Tamaño máximo: 10 MB. Solo PDF.
              </p>
            </div>

            <div class="md:col-span-2 note text-sm">
              <div class="font-medium">⚠️ Nota:</div>
              <div>
                La constancia debe contener: nombre y apellidos del estudiante,
                rango de fechas, nombre de la empresa, RUC, cargo, papel
                membretado, sello y firma.
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Navigation -->
        <div
          class="mt-6 pt-6 border-t border-gray-100 flex items-center justify-between gap-4"
        >
          <div>
            <button
              type="button"
              id="prev-btn"
              class="hidden px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-600 hover:bg-gray-50"
            >
              Anterior
            </button>
          </div>
          <div class="flex items-center gap-3">
            <button
              type="button"
              id="save-draft"
              class="px-4 py-2 rounded-lg border border-gray-200 text-sm text-text-muted hover:bg-gray-50"
            >
              Guardar borrador
            </button>
            <button
              type="button"
              id="next-btn"
              class="px-6 py-2 rounded-full bg-primary text-white text-sm font-bold shadow"
            >
              Siguiente
            </button>
            <button
              type="submit"
              id="submit-btn"
              class="px-6 py-2 rounded-full bg-primary text-white text-sm font-bold shadow hidden"
            >
              Enviar formulario
            </button>
          </div>
        </div>
      </form>
    </main>

    <script>
      const steps = Array.from(document.querySelectorAll('[data-step]'))
      const total = steps.length
      let current = 0

      // TEMPORAL: desactivar validación de correo para pruebas.
      // Recordar: ajustar a `false` o eliminar antes de pasar a producción.
      const SKIP_EMAIL_VALIDATION = true
      const MIN_WORDS = 150

      const stepTitles = [
        { title: 'Estudiante', subtitle: 'Datos personales' },
        { title: 'Organización (I)', subtitle: 'Identificación' },
        { title: 'Descripción', subtitle: 'Actividades' },
      ]

      // Expose for onClick in HTML
      window.goToStep = (index) => {
        if (index < current) {
          // Allow going back always
          current = index
          updateUI()
        } else if (index > current) {
          // Validate intermediate steps before jumping forward
          // This is simplistic; usually you'd check every step between current and target
          // But for this UI enhancement, we'll just check if we can go next
          const invalid = validateStep(current)
          if (!invalid) {
            // Only allow traversing one by one for validation strictness,
            // or you could implement recursive validation.
            // For now, let's keep strict flow but allow clicking prev steps.
          }
        }
      }

      const updateUI = () => {
        // 1. Toggle Form Sections
        steps.forEach((s, i) => {
          s.classList.toggle('hidden', i !== current)
          if (i === current) {
            s.classList.add('animate-fade-in')
          }
        })

        // 2. Update Desktop Stepper
        const progressPercentage = (current / (total - 1)) * 100
        const progressBar = document.getElementById('stepper-progress')
        if (progressBar) progressBar.style.width = `${progressPercentage}%`

        for (let i = 0; i < total; i++) {
          const bullet = document.getElementById('bullet-' + (i + 1))
          if (!bullet) continue // Safety check

          const btn = bullet.parentElement
          const labelContainer = btn.querySelector('div:last-child')
          const title = labelContainer.querySelector('span:first-child')
          const subtitle = labelContainer.querySelector('span:last-child')

          // Reset classes base
          bullet.className =
            'w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-all duration-300 z-10 relative'

          if (i < current) {
            // Completed
            bullet.classList.add('bg-primary', 'border-primary', 'text-white')
            bullet.classList.remove(
              'bg-white',
              'border-gray-200',
              'text-gray-400',
              'scale-110',
            )
            bullet.innerHTML =
              '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>'

            title.classList.remove('opacity-60', 'text-primary')
            title.classList.add('text-gray-900')
            subtitle.classList.remove('opacity-60')

            btn.disabled = false
            btn.onclick = ((idx) => () => {
              current = idx
              updateUI()
            })(i)
          } else if (i === current) {
            // Active
            bullet.classList.add(
              'bg-primary',
              'border-primary',
              'text-white',
              'scale-110',
              'shadow-[0_0_0_4px_rgba(124,58,237,0.2)]',
            )
            bullet.classList.remove(
              'bg-white',
              'border-gray-200',
              'text-gray-400',
            )
            bullet.innerHTML = i + 1

            title.classList.remove('opacity-60')
            title.classList.add('text-primary')
            subtitle.classList.remove('opacity-60')

            btn.disabled = true
            btn.onclick = null
          } else {
            // Future
            bullet.classList.add('bg-white', 'border-gray-200', 'text-gray-400')
            bullet.classList.remove(
              'bg-primary',
              'border-primary',
              'text-white',
              'scale-110',
              'shadow-[0_0_0_4px_rgba(124,58,237,0.2)]',
            )
            bullet.innerHTML = i + 1

            title.classList.add('opacity-60')
            title.classList.remove('text-primary')
            subtitle.classList.add('opacity-60')

            btn.disabled = true
            btn.onclick = null
          }
        }

        // 3. Update Mobile Stepper
        if (stepTitles[current]) {
          const mTitle = document.getElementById('mobile-step-title')
          if (mTitle) mTitle.textContent = stepTitles[current].title

          const mSubtitle = document.getElementById('mobile-step-subtitle')
          if (mSubtitle) mSubtitle.textContent = stepTitles[current].subtitle
        }

        const mCurrent = document.getElementById('mobile-step-current')
        if (mCurrent) mCurrent.textContent = current + 1

        const mTotal = document.getElementById('mobile-step-total')
        if (mTotal) mTotal.textContent = total

        const mCircle = document.getElementById('mobile-progress-circle')
        if (mCircle) {
          const circum = 100 // approximate since dasharray is 0,100
          const dash = Math.round(((current + 1) / total) * 100)
          // Logic for donut chart via stroke-dasharray="current, 100" where 100 is circle length roughly
          mCircle.setAttribute('stroke-dasharray', `${dash}, 100`)
        }

        // 4. Update Buttons visibility
        document
          .getElementById('prev-btn')
          .classList.toggle('hidden', current === 0)
        document
          .getElementById('next-btn')
          .classList.toggle('hidden', current === total - 1)
        document
          .getElementById('submit-btn')
          .classList.toggle('hidden', current !== total - 1)

        window.scrollTo({ top: 0, behavior: 'smooth' })
      }

      function validateStep(index) {
        const fs = steps[index]
        const required = Array.from(fs.querySelectorAll('[required]'))
        for (const el of required) {
          if (el.type === 'file') {
            if (!el.files || el.files.length === 0) {
              console.error(
                'Validación falló en archivo requerido:',
                el.name || el.id,
              )
              return el
            }
            // Validar tamaño máximo 10MB (10 * 1024 * 1024 bytes)
            if (el.files[0].size > 10 * 1024 * 1024) {
              Swal.fire({
                icon: 'warning',
                title: 'Archivo muy pesado',
                text: 'El archivo adjunto no debe superar los 10MB.',
              })
              console.error(
                'Validación falló en tamaño de archivo:',
                el.name || el.id,
              )
              return el
            }
          } else if (!el.value || el.value.toString().trim() === '') {
            console.error(
              'Validación falló en campo requerido:',
              el.name || el.id,
              el,
            )
            return el
          } else {
            // For checkboxes/radios if they were required but skipped by logic above?
            // But they have .value usually.
            // If type="checkbox", .value is "on" usually. check .checked
            if (
              (el.type === 'checkbox' || el.type === 'radio') &&
              !el.checked
            ) {
              console.log(
                'Validación falló en checkbox/radio requerido:',
                el.name || el.id,
              )
              return el
            }
          }
        }

        // Validación específica de correo neumann.education en el paso 0
        // TEMPORAL: validación desactivada para pruebas. Revertir antes de producción.
        if (index === 0 && !SKIP_EMAIL_VALIDATION) {
          const emailInput = fs.querySelector(
            'input[name="correo_estudiantil"]',
          )
          if (emailInput && emailInput.value) {
            const email = emailInput.value.trim().toLowerCase()
            if (!email.endsWith('@neumann.global')) {
              console.error('Validación falló: Correo no es @neumann.global')
              Swal.fire({
                icon: 'warning',
                title: 'Correo inválido',
                text: 'El correo estudiantil debe ser del dominio @neumann.global',
              })
              return emailInput
            }
          }
        }

        // Validación específica de horas mínimas
        if (index === 1) {
          const horasInput = fs.querySelector('input[name="horas"]')
          if (horasInput && horasInput.value) {
            const h = parseInt(horasInput.value, 10)
            if (h < 64) {
              console.error('Validación falló: Horas insuficientes (' + h + ')')
              Swal.fire({
                icon: 'warning',
                title: 'Horas insuficientes',
                text: 'El total de horas realizadas debe ser igual o mayor a 64.',
              })
              return horasInput
            }
          }
        }

        return null
      }

      /* -------------------------
         Local draft helpers
         - Guarda todos los campos excepto el archivo PDF
         - Key: 'efsrt_draft_v1'
         ------------------------- */
      const DRAFT_KEY = 'efsrt_draft_v1'

      function getFormObjectForDraft() {
        const form = document.getElementById('efsrt-form')
        const fd = new FormData(form)
        const obj = {}
        for (const [k, v] of fd.entries()) {
          if (k === 'constancia') continue // no guardamos archivos en localStorage
          obj[k] = v
        }
        obj.__savedAt = new Date().toISOString()
        return obj
      }

      function saveDraftToLocalStorage() {
        try {
          const data = getFormObjectForDraft()
          localStorage.setItem(DRAFT_KEY, JSON.stringify(data))
          return true
        } catch (err) {
          console.error('Error saving draft', err)
          return false
        }
      }

      function loadDraftFromLocalStorage() {
        const raw = localStorage.getItem(DRAFT_KEY)
        if (!raw) return null
        try {
          return JSON.parse(raw)
        } catch (err) {
          console.error('Invalid draft JSON', err)
          return null
        }
      }

      function populateFormFromDraft(draft) {
        if (!draft) return
        for (const key of Object.keys(draft)) {
          if (key.startsWith('__')) continue
          const el = document.querySelector('[name="' + key + '"]')
          if (!el) continue
          if (el.tagName === 'SELECT') {
            el.value = draft[key]
          } else if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = !!draft[key]
          } else {
            el.value = draft[key]
          }
        }
      }

      function clearDraft() {
        localStorage.removeItem(DRAFT_KEY)
      }

      function loadDraftOnStart() {
        const draft = loadDraftFromLocalStorage()
        if (!draft) return
        Swal.fire({
          title: 'Borrador encontrado',
          html:
            'Se encontró un borrador guardado localmente.<br/><small>Guardado el: ' +
            new Date(draft.__savedAt).toLocaleString() +
            '</small>',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Cargar borrador',
          cancelButtonText: 'Eliminar borrador',
        }).then((res) => {
          if (res.isConfirmed) {
            populateFormFromDraft(draft)
            Swal.fire({ icon: 'success', title: 'Borrador cargado' })
          } else if (res.dismiss === Swal.DismissReason.cancel) {
            clearDraft()
            Swal.fire({ icon: 'info', title: 'Borrador eliminado' })
          }
        })
      }

      document.getElementById('next-btn').addEventListener('click', () => {
        const invalid = validateStep(current)
        if (invalid) {
          invalid.focus()
          // Si el input inválido es el correo y ya mostramos un error específico en validateStep, no mostramos el genérico.
          // Una forma sencilla es chequear si ya hay un swal abierto o simplemente diferenciamos el mensaje.
          // Pero como validateStep ya inyecta un Swal para el correo, podemos evitar el genérico si sabemos que fue ese error.

          // Mejor enfoque: validateStep devuelve el error o null.
          // Pero para no reescribir todo, validemos si el error NO fue mostrado ya.

          if (!Swal.isVisible()) {
            Swal.fire({
              icon: 'warning',
              title: 'Falta información',
              text: 'Completa los campos obligatorios antes de continuar.',
            })
          }
          return
        }
        if (current < total - 1) {
          current++
          updateUI()
        }
      })

      document.getElementById('prev-btn').addEventListener('click', () => {
        if (current > 0) {
          current--
          updateUI()
        }
      })

      document.getElementById('efsrt-form').addEventListener('submit', (e) => {
        e.preventDefault()
        // validate last step and all required fields across form
        for (let i = 0; i < total; i++) {
          const invalid = validateStep(i)
          if (invalid) {
            current = i
            updateUI()
            invalid.focus()
            Swal.fire({
              icon: 'warning',
              title: 'Campos incompletos',
              text: 'Revisa las secciones marcadas y completa los campos obligatorios.',
            })
            return
          }
        }

        // Summary (minimal) and confirmation
        const nombre = document.querySelector('[name="nombres"]').value || '-'
        const apellidos =
          document.querySelector('[name="apellidos"]').value || '-'
        const programa =
          document.querySelector('[name="programa"]').value || '-'
        Swal.fire({
          title: '¿Confirmar envío?',
          html: `<strong>${nombre} ${apellidos}</strong><br/>Programa: ${programa}`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, enviar',
        }).then((result) => {
          if (result.isConfirmed) {
            // Enviar formulario a Apps Script vía URL externa
            const submitBtn = document.getElementById('submit-btn')
            const originalText = submitBtn.textContent
            submitBtn.disabled = true
            submitBtn.textContent = 'Enviando...'

            const form = document.getElementById('efsrt-form')
            const formData = new FormData(form)
            const data = {}

            // Convertir FormData a un objeto simple
            for (const [key, value] of formData.entries()) {
              // Excluir el archivo 'constancia' aquí, lo tratamos aparte
              if (key !== 'constancia') {
                data[key] = value
              }
            }

            // Función interna para realizar el Fetch
            const sendData = (payload) => {
              // URL del Web App de Apps Script
              const SCRIPT_URL =
                'https://script.google.com/macros/s/AKfycbwBFz4efCzuyCj7BwjHHBiKYaPCbDnp4IgjlBuBfFa-DAxjHk-MfpXNhjMo9VWcWbCk/exec'

              fetch(SCRIPT_URL, {
                method: 'POST',
                // Evitamos el error CORS preflight (OPTIONS) usando text/plain
                headers: {
                  'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload),
              })
                .then((response) => response.json())
                .then((resp) => {
                  submitBtn.disabled = false
                  submitBtn.textContent = originalText

                  if (resp.success) {
                    Swal.fire({
                      icon: 'success',
                      title: '¡Éxito!',
                      text: 'Tu formulario ha sido enviado y registrado correctamente.',
                    })
                    form.reset()
                    clearDraft()
                    current = 0
                    updateUI()
                  } else {
                    Swal.fire({
                      icon: 'error',
                      title: 'Error',
                      text: resp.message || 'Error desconocido al guardar.',
                    })
                  }
                })
                .catch((error) => {
                  submitBtn.disabled = false
                  submitBtn.textContent = originalText
                  console.error(error)

                  Swal.fire({
                    icon: 'error',
                    title: 'Error de conexión',
                    text: 'Hubo un problema al conectar con el servidor. Intenta de nuevo.',
                  })
                })
            }

            // Manejo de archivo PDF a Base64
            const fileInput = form.querySelector('input[name="constancia"]')
            if (fileInput.files.length > 0) {
              const file = fileInput.files[0]
              const reader = new FileReader()

              reader.onload = function (evt) {
                // evt.target.result es string tipo: "data:application/pdf;base64,JVBERi0xLjQK..."
                // Tomamos solo la parte Base64 después de la coma
                const base64String = evt.target.result.split(',')[1]

                data.constancia = {
                  name: file.name,
                  mimeType: file.type,
                  data: base64String,
                }

                sendData(data)
              }

              reader.onerror = function (err) {
                console.error('Error leyendo archivo', err)
                submitBtn.disabled = false
                submitBtn.textContent = originalText
                Swal.fire({
                  icon: 'error',
                  title: 'Error de archivo',
                  text: 'No se pudo leer el archivo adjunto.',
                })
              }

              reader.readAsDataURL(file)
            } else {
              // Si no hay archivo (aunque es required, por seguridad)
              sendData(data)
            }
          }
        })
      })

      document.getElementById('save-draft').addEventListener('click', () => {
        const ok = saveDraftToLocalStorage()
        if (ok) {
          Swal.fire({
            icon: 'success',
            title: 'Borrador guardado',
            html: 'Los datos se han guardado localmente.<br/><small>Nota: el archivo PDF no se guarda en el borrador.</small>',
            timer: 2000,
            showConfirmButton: false,
          })
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo guardar el borrador en el almacenamiento local.',
          })
        }
      })

      function updateWordCount() {
        const textarea = document.getElementById('actividades-input')
        const counter = document.getElementById('word-count')
        if (!textarea || !counter) return
        const words = textarea.value.trim().split(/\s+/).filter(Boolean)
        counter.textContent = `${words.length} palabras`
      }

      const actividadesEl = document.getElementById('actividades-input')
      if (actividadesEl) {
        actividadesEl.addEventListener('input', updateWordCount)
      }

      // Initialize Custom Drag & Drop Logic
      const dropZone = document.getElementById('drop-zone')
      const fileInput = document.getElementById('constancia-input')
      const fileNameDisplay = document.getElementById('file-name-display')

      if (dropZone && fileInput) {
        // Highlight on drag
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault()
          dropZone.classList.add('bg-blue-50', 'border-primary')
        })

        dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault()
          dropZone.classList.remove('bg-blue-50', 'border-primary')
        })

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault()
          dropZone.classList.remove('bg-blue-50', 'border-primary')
          if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files
            updateFileDisplay()
          }
        })

        fileInput.addEventListener('change', updateFileDisplay)

        function updateFileDisplay() {
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0]
            if (file.size > 10 * 1024 * 1024) {
              Swal.fire({
                icon: 'warning',
                title: 'Archivo demasiado grande',
                text: 'El archivo PDF no debe superar los 10 MB.',
              })
              fileInput.value = ''
              if (fileNameDisplay) {
                fileNameDisplay.textContent = 'Solo PDF hasta 10MB'
                fileNameDisplay.classList.remove('text-primary', 'font-bold')
              }
              return
            }
            if (fileNameDisplay) {
              fileNameDisplay.textContent = `Archivo seleccionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`
              fileNameDisplay.classList.add('text-primary', 'font-bold')
            }
          } else {
            if (fileNameDisplay) {
              fileNameDisplay.textContent = 'Solo PDF hasta 10MB'
              fileNameDisplay.classList.remove('text-primary', 'font-bold')
            }
          }
        }
      }

      loadDraftOnStart()
      updateWordCount()
      updateUI()
    </script>
  </body>
</html>




